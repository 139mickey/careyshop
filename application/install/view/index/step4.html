{extend name="layout"/}
{block name="content"}
<section class="section">
    <div class="step">
        <ul>
            <li class="on"><em>1</em>检测环境</li>
            <li class="on"><em>2</em>创建数据</li>
            <li class="current"><em>3</em>完成安装</li>
        </ul>
    </div>

    <div class="install" id="log">
        <ul id="log-inner">
        </ul>
    </div>

    <div class="bottom tac">
        <a href="javascript:" class="btn_old">
            <img src="static/install/images/loading.gif" align="absmiddle"/>
            <span>正在安装...</span>
        </a>
    </div>
</section>

{load href="/static/install/js/jquery.js"/}
<script type="text/javascript">
    $(document).ready(function () {
        $('#log').animate({
            scrollTop: $('#log').get(0).scrollHeight
        });
    });

    function insert_log(msg) {
        $('#log-inner').append(msg);
    }
</script>

{php}
use think\Db;

// 连接数据库
$data = session('installData');
$dbInstance = Db::connect([
    'type'     => $data['type'],
    'hostname' => $data['hostname'],
    'database' => $data['database'],
    'username' => $data['username'],
    'password' => $data['password'],
    'hostport' => $data['hostport'],
    'charset'  => 'utf8mb4',
    'prefix'   => $data['prefix'],
]);

// 创建数据表
create_data($dbInstance, $data);

// 生成配置文件
write_config($data);

// echo "<script type=\"text/javascript\">location.href='".request()->baseFile()."?s=/index/complete.html'</script>";
{/php}
{/block}
